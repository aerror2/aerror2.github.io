
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xbox One 控制器转换为 macOS HID 设备的工作原理分析</title>
    <link rel="stylesheet" href="styles.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>
<body>
    <div class="header">
        <a href="index.html">← 返回目录</a>
    </div>
    
    <h1>Xbox One 控制器转换为 macOS HID 设备的工作原理分析</h1>
    <div class="source-link">原文链接: <a href="https://blog.csdn.net/aerror/article/details/149077098" target="_blank">https://blog.csdn.net/aerror/article/details/149077098</a></div>
    
    <div class="article-meta">
        <div class="meta-item"><i class="far fa-calendar-alt"></i> 发布时间: 2025-07-02 19:49:23</div>
        <div class="meta-item"><i class="far fa-eye"></i> 浏览量: 670</div>
        
        <div class="meta-item"><i class="far fa-star"></i> 收藏数: 16</div>
        <div class="meta-item"><i class="far fa-thumbs-up"></i> 点赞数: 12</div>
    </div>
    
    <div class="article-tags">标签: <span class="tag">xbox</span>, <span class="tag">macos</span></div>
    
    <div class="article-description">使用 IOKit 框架与 Xbox One 控制器通信，读取原始输入数据将这些数据解析为结构化的按钮和摇杆状态创建一个虚拟 HID 设备，生成标准的 HID 报告描述符将控制器状态映射到虚拟 HID 设备状态通过内核驱动程序将虚拟设备注册到系统这种方法允许 macOS 将 Xbox One 控制器识别为标准游戏手柄，从而在不需要官方驱动的情况下实现兼容性。</div>
    
    <div class="article-content">
        <div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h2><a id="Xbox_One__macOS_HID__3"></a>Xbox One 控制器转换为 macOS HID 设备的工作原理分析</h2>
<p>源代码在 https://github.com/guilhermearaujo/xboxonecontrollerenabler.git</p>
<p>这个工程的核心功能是将 Xbox One 控制器（macOS 原生不支持的设备）转换为 macOS 可识别的 HID 设备。这里通过分析代码，详细解释其工作原理、设备描述和报告描述符的实现。</p>
<h3><a id="_10"></a>整体架构</h3>
<p>该项目由三个主要部分组成：</p>
<ol><li><strong>Xbox 控制器通信层</strong>：通过 IOKit 框架与 Xbox One 控制器进行 USB 通信</li><li><strong>虚拟 HID 设备层</strong>：使用 VHID 框架创建虚拟 HID 设备</li><li><strong>系统集成层</strong>：使用 WirtualJoy 框架将虚拟设备注册到 macOS 系统</li></ol>
<h3><a id="Xbox_One__18"></a>Xbox One 控制器设备描述</h3>
<p>Xbox One 控制器的设备描述在代码中通过 <code>XboxOneButtonMap</code> 结构体定义：</p>
<pre><code class="prism language-c hljs"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  bool sync<span class="token punctuation">;</span>
  bool dummy<span class="token punctuation">;</span> <span class="token comment">// Always 0.</span>
  bool menu<span class="token punctuation">;</span>  <span class="token comment">// Not entirely sure what these are</span>
  bool view<span class="token punctuation">;</span>  <span class="token comment">// called on the new controller</span>
  
  bool a<span class="token punctuation">;</span>
  bool b<span class="token punctuation">;</span>
  bool x<span class="token punctuation">;</span>
  bool y<span class="token punctuation">;</span>
  
  bool dpad_up<span class="token punctuation">;</span>
  bool dpad_down<span class="token punctuation">;</span>
  bool dpad_left<span class="token punctuation">;</span>
  bool dpad_right<span class="token punctuation">;</span>
  
  bool bumper_left<span class="token punctuation">;</span>
  bool bumper_right<span class="token punctuation">;</span>
  bool stick_left_click<span class="token punctuation">;</span>
  bool stick_right_click<span class="token punctuation">;</span>
  
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> trigger_left<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> trigger_right<span class="token punctuation">;</span>
  
  <span class="token keyword">short</span> stick_left_x<span class="token punctuation">;</span>
  <span class="token keyword">short</span> stick_left_y<span class="token punctuation">;</span>
  <span class="token keyword">short</span> stick_right_x<span class="token punctuation">;</span>
  <span class="token keyword">short</span> stick_right_y<span class="token punctuation">;</span>
  
  bool home<span class="token punctuation">;</span>
<span class="token punctuation">}</span> XboxOneButtonMap<span class="token punctuation">;</span>
</code></pre>
<p>这个结构体映射了 Xbox One 控制器的所有输入元素，包括：</p>
<ul><li>按钮（A、B、X、Y、方向键、肩键等）</li><li>摇杆（左右摇杆的 X/Y 坐标）</li><li>扳机键（左右扳机的模拟值）</li></ul>
<h3><a id="_61"></a>控制器通信实现</h3>
<p><code>GAXboxControllerCommunication</code> 类负责与 Xbox One 控制器通信：</p>
<ol><li>通过 USB 供应商 ID (0x045e) 和产品 ID (0x02d1) 识别 Xbox One 控制器</li><li>使用 IOKit 框架打开设备并配置接口</li><li>初始化控制器并开始轮询数据</li><li>在 <code>poll</code> 方法中读取原始数据并解析为 <code>XboxOneButtonMap</code> 结构</li></ol>
<p>关键代码片段：</p>
<pre><code class="prism language-objc hljs">
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>poll <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>shouldPoll<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    UInt32 numBytes <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> dataBuffer<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    returnCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>usbInterface<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ReadPipe</span><span class="token punctuation">(</span>usbInterface<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> dataBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>numBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">==</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Byte b <span class="token operator">=</span> dataBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>sync  <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>dummy <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>menu  <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>view  <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      
      buttonMap<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      
      b <span class="token operator">=</span> dataBuffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>dpad_up    <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>dpad_down  <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>dpad_left  <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>dpad_right <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      
      buttonMap<span class="token punctuation">.</span>bumper_left       <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>bumper_right      <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>stick_left_click  <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>stick_right_click <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      
      buttonMap<span class="token punctuation">.</span>trigger_left  <span class="token operator">=</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>trigger_right <span class="token operator">=</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      buttonMap<span class="token punctuation">.</span>stick_left_x  <span class="token operator">=</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> dataBuffer<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>stick_left_y  <span class="token operator">=</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> dataBuffer<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>stick_right_x <span class="token operator">=</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> dataBuffer<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      buttonMap<span class="token punctuation">.</span>stick_right_y <span class="token operator">=</span> <span class="token punctuation">(</span>dataBuffer<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> dataBuffer<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token punctuation">[</span>delegate controllerDidUpdateData<span class="token punctuation">:</span>buttonMap<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numBytes <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      buttonMap<span class="token punctuation">.</span>home <span class="token operator">=</span> dataBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">[</span>delegate controllerDidUpdateData<span class="token punctuation">:</span>buttonMap<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">0.005f</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="_HID__123"></a>虚拟 HID 设备实现</h3>
<p><code>VHIDDevice</code> 类负责创建虚拟 HID 设备，它通过组合 <code>VHIDButtonCollection</code> 和 <code>VHIDPointerCollection</code> 来管理按钮和指针（摇杆）状态：</p>
<pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>initWithType<span class="token punctuation">:</span><span class="token punctuation">(</span>VHIDDeviceType<span class="token punctuation">)</span>type
      pointerCount<span class="token punctuation">:</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>pointerCount
       buttonCount<span class="token punctuation">:</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>buttonCount
        isRelative<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>isRelative
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">self</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">super</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>

    m_Type      <span class="token operator">=</span> type<span class="token punctuation">;</span>
    m_Buttons   <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>VHIDButtonCollection alloc<span class="token punctuation">]</span> initWithButtonCount<span class="token punctuation">:</span>buttonCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
    m_Pointers  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>VHIDPointerCollection alloc<span class="token punctuation">]</span> initWithPointerCount<span class="token punctuation">:</span>pointerCount
                                                           isRelative<span class="token punctuation">:</span>isRelative<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// ... 初始化状态数据</span>
    m_Descriptor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> createDescriptor<span class="token punctuation">]</span> retain<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4><a id="HID__147"></a>HID 报告描述符生成</h4>
<p><code>VHIDDevice</code> 类的 <code>createDescriptor</code> 方法负责生成 HID 报告描述符，这是关键部分：</p>
<pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span>NSData<span class="token operator">*</span><span class="token punctuation">)</span>createDescriptor
<span class="token punctuation">{<!-- --></span>
    BOOL             isMouse        <span class="token operator">=</span> <span class="token punctuation">(</span>m_Type <span class="token operator">==</span> VHIDDeviceTypeMouse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSData          <span class="token operator">*</span>buttonsHID     <span class="token operator">=</span> <span class="token punctuation">[</span>m_Buttons descriptor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSData          <span class="token operator">*</span>pointersHID    <span class="token operator">=</span> <span class="token punctuation">[</span>m_Pointers descriptor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSMutableData   <span class="token operator">*</span>result         <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableData dataWithLength<span class="token punctuation">:</span>
                                                    <span class="token punctuation">[</span>buttonsHID length<span class="token punctuation">]</span> <span class="token operator">+</span>
                                                    <span class="token punctuation">[</span>pointersHID length<span class="token punctuation">]</span> <span class="token operator">+</span>
                                                    <span class="token punctuation">(</span><span class="token punctuation">(</span>isMouse<span class="token punctuation">)</span><span class="token operator">?</span>
                                                        <span class="token punctuation">(</span>HIDDescriptorMouseAdditionalBytes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                                                        <span class="token punctuation">(</span>HIDDescriptorJoystickAdditionalBytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   <span class="token operator">*</span>data           <span class="token operator">=</span> <span class="token punctuation">[</span>result mutableBytes<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    usage          <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isMouse<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token comment">// USAGE_PAGE (Generic Desktop)</span>
    <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0x09</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token operator">*</span>data <span class="token operator">=</span> usage<span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span>     <span class="token comment">// USAGE (Mouse/Game Pad)</span>
    <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0xA1</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token comment">// COLLECTION (Application)</span>

    <span class="token comment">// ... 添加按钮和指针描述符</span>

    <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0xC0</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// END_COLLECTION</span>
    <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token number">0xC0</span><span class="token punctuation">;</span> data<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// END_COLLECTION</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这个方法创建了一个标准的 HID 报告描述符，定义了设备类型（游戏手柄）、按钮和指针（摇杆）的布局。</p>
<h3><a id="_182"></a>系统集成</h3>
<p><code>WJoyDevice</code> 和 <code>WJoyDeviceImpl</code> 类负责将虚拟 HID 设备注册到 macOS 系统：</p>
<ol><li>加载内核驱动程序</li><li>创建与驱动程序的连接</li><li>设置设备属性（产品名称、供应商 ID、产品 ID 等）</li><li>启用设备并更新 HID 状态</li></ol>
<p>关键代码：</p>
<pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>initWithHIDDescriptor<span class="token punctuation">:</span><span class="token punctuation">(</span>NSData<span class="token operator">*</span><span class="token punctuation">)</span>HIDDescriptor properties<span class="token punctuation">:</span><span class="token punctuation">(</span>NSDictionary<span class="token operator">*</span><span class="token punctuation">)</span>properties
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ... 初始化代码</span>

    m_Impl <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WJoyDeviceImpl alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置设备属性</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>productString <span class="token operator">!=</span> nil<span class="token punctuation">)</span>
        <span class="token punctuation">[</span>m_Impl setDeviceProductString<span class="token punctuation">:</span>productString<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// ... 设置其他属性</span>

    <span class="token comment">// 启用设备</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>m_Impl enable<span class="token punctuation">:</span>HIDDescriptor<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span><span class="token keyword">self</span> release<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="_217"></a>数据流转换过程</h3>
<p>整个数据流转换过程如下：</p>
<ol><li><code>GAXboxControllerCommunication</code> 从 Xbox One 控制器读取原始 USB 数据</li><li>数据被解析为 <code>XboxOneButtonMap</code> 结构体</li><li><code>GAXboxController</code> 处理这些数据并提供高级访问方法</li><li><code>GAMainViewController</code> 将控制器数据映射到虚拟 HID 设备：</li></ol>
<pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>updateVHID<span class="token punctuation">:</span><span class="token punctuation">(</span>GAXboxController <span class="token operator">*</span><span class="token punctuation">)</span>controller <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">[</span>_VHID setButton<span class="token punctuation">:</span><span class="token number">0</span> pressed<span class="token punctuation">:</span><span class="token punctuation">[</span>controller A<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span>_VHID setButton<span class="token punctuation">:</span><span class="token number">1</span> pressed<span class="token punctuation">:</span><span class="token punctuation">[</span>controller B<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// ... 设置其他按钮</span>
  
  NSPoint point <span class="token operator">=</span> NSZeroPoint<span class="token punctuation">;</span>
  point<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">[</span>controller leftAnalogX<span class="token punctuation">]</span><span class="token punctuation">;</span>
  point<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">[</span>controller leftAnalogY<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span>_VHID setPointer<span class="token punctuation">:</span><span class="token number">0</span> position<span class="token punctuation">:</span>point<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// ... 设置其他指针</span>
<span class="token punctuation">}</span>
</code></pre>
<ol start="5"><li><code>VHIDDevice</code> 更新其内部状态并通知代理</li><li><code>WJoyDevice</code> 将更新后的 HID 状态发送到系统</li></ol>
<h3><a id="_248"></a>报告提交流程</h3>
<ol><li> <p><strong>VHIDDevice.m 中的状态更新和报告生成</strong>：<br/> 当按钮或指针状态发生变化时，VHIDDevice会生成新的状态报告：</p> <pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setButton<span class="token punctuation">:</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>buttonIndex pressed<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>pressed <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// ... 检查按钮状态是否变化</span>
  <span class="token punctuation">[</span>m_Buttons setButton<span class="token punctuation">:</span>buttonIndex pressed<span class="token punctuation">:</span>pressed<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span>m_Delegate <span class="token operator">!=</span> nil<span class="token punctuation">)</span>
      <span class="token punctuation">[</span>m_Delegate VHIDDevice<span class="token punctuation">:</span><span class="token keyword">self</span> stateChanged<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">self</span> state<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span>NSData<span class="token operator">*</span><span class="token punctuation">)</span>state <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>m_State mutableBytes<span class="token punctuation">]</span><span class="token punctuation">;</span>
  NSData <span class="token operator">*</span>buttonState <span class="token operator">=</span> <span class="token punctuation">[</span>m_Buttons state<span class="token punctuation">]</span><span class="token punctuation">;</span>
  NSData <span class="token operator">*</span>pointerState <span class="token operator">=</span> <span class="token punctuation">[</span>m_Pointers state<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 合并按钮和指针状态到一个完整的HID报告</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>buttonState <span class="token operator">!=</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">[</span>buttonState bytes<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>buttonState length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span>pointerState <span class="token operator">!=</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token punctuation">[</span>buttonState length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pointerState bytes<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pointerState length<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>m_State retain<span class="token punctuation">]</span> autorelease<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>VHIDButtonCollection.m 和 VHIDPointerCollection.m</strong>：<br/> 这两个类负责维护按钮和指针的状态，并生成对应的HID报告部分：</p> <p>在VHIDButtonCollection中：</p> <pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setButton<span class="token punctuation">:</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>buttonIndex pressed<span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>pressed <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// ... 检查按钮索引</span>
  NSUInteger buttonByte <span class="token operator">=</span> buttonIndex <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
  NSUInteger buttonBit <span class="token operator">=</span> buttonIndex <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">[</span>m_State mutableBytes<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 设置对应位的按钮状态</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pressed<span class="token punctuation">)</span>
      data<span class="token punctuation">[</span>buttonByte<span class="token punctuation">]</span> <span class="token operator">|</span><span class="token operator">=</span> buttonMasks<span class="token punctuation">[</span>buttonBit<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
      data<span class="token punctuation">[</span>buttonByte<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>buttonMasks<span class="token punctuation">[</span>buttonBit<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>在VHIDPointerCollection中：</p> <pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setPointer<span class="token punctuation">:</span><span class="token punctuation">(</span>NSUInteger<span class="token punctuation">)</span>pointerIndex position<span class="token punctuation">:</span><span class="token punctuation">(</span>NSPoint<span class="token punctuation">)</span>position <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// ... 检查指针索引</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">[</span>m_State mutableBytes<span class="token punctuation">]</span> <span class="token operator">+</span> pointerIndex <span class="token operator">*</span> HIDStatePointerSize<span class="token punctuation">;</span>
  
  <span class="token comment">// 设置X和Y坐标值</span>
  <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>VHIDPointerCollection clipCoordinateTo<span class="token punctuation">:</span>position<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">[</span>VHIDPointerCollection clipCoordinateTo<span class="token punctuation">:</span>position<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>GAMainViewController.m 中的代理方法</strong>：<br/> 当VHIDDevice状态变化时，通过代理方法将状态传递给WJoyDevice：</p> <pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>VHIDDevice<span class="token punctuation">:</span><span class="token punctuation">(</span>VHIDDevice <span class="token operator">*</span><span class="token punctuation">)</span>device stateChanged<span class="token punctuation">:</span><span class="token punctuation">(</span>NSData <span class="token operator">*</span><span class="token punctuation">)</span>state <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">[</span>_virtualDevice updateHIDState<span class="token punctuation">:</span>state<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>WJoyDevice.m 中的更新方法</strong>：<br/> 最后，WJoyDevice将HID状态报告提交给系统：</p> <pre><code class="prism language-objc hljs"><span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>updateHIDState<span class="token punctuation">:</span><span class="token punctuation">(</span>NSData<span class="token operator">*</span><span class="token punctuation">)</span>HIDState <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>m_Impl updateState<span class="token punctuation">:</span>HIDState<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol>
<h3><a id="_329"></a>总结</h3>
<p>这个工程通过以下步骤将 Xbox One 控制器转换为 macOS 可识别的 HID 设备：</p>
<ol><li>使用 IOKit 框架与 Xbox One 控制器通信，读取原始输入数据</li><li>将这些数据解析为结构化的按钮和摇杆状态</li><li>创建一个虚拟 HID 设备，生成标准的 HID 报告描述符</li><li>将控制器状态映射到虚拟 HID 设备状态</li><li>通过内核驱动程序将虚拟设备注册到系统</li></ol>
<p>这种方法允许 macOS 将 Xbox One 控制器识别为标准游戏手柄，从而在不需要官方驱动的情况下实现兼容性。</p>
</div>
    </div>
    
    <div class="footer">
        <p>发表时间: 2025-07-02 19:49:23</p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <script>
        // 处理代码块，添加语言类和复制功能
        document.addEventListener('DOMContentLoaded', function() {            
            // 为没有指定语言的代码块添加默认语言
            document.querySelectorAll('pre code:not([class*="language-"])').forEach(function(block) {
                block.className = 'hljs language-javascript';
            });
            
            // 确保所有代码块都有hljs类
            document.querySelectorAll('pre code[class*="language-"]:not([class*="hljs"])').forEach(function(block) {
                block.className = 'hljs ' + block.className;
            });
            
            // 为所有代码块添加自定义复制按钮
            document.querySelectorAll('pre').forEach(function(pre) {
                // 创建复制按钮
                var copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = '复制';
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';
                copyButton.style.background = 'rgba(0,0,0,0.3)';
                copyButton.style.color = 'white';
                copyButton.style.border = 'none';
                copyButton.style.borderRadius = '3px';
                copyButton.style.padding = '5px 10px';
                copyButton.style.fontSize = '0.8em';
                copyButton.style.cursor = 'pointer';
                copyButton.style.display = 'none';
                
                // 鼠标悬停时显示按钮
                pre.addEventListener('mouseenter', function() {
                    copyButton.style.display = 'block';
                });
                
                pre.addEventListener('mouseleave', function() {
                    copyButton.style.display = 'none';
                });
                
                // 点击复制按钮时复制代码
                copyButton.addEventListener('click', function() {
                    var code = pre.querySelector('code');
                    var text = code.textContent || code.innerText;
                    
                    // 使用现代的 Clipboard API
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text)
                            .then(function() {
                                copyButton.textContent = '已复制!';
                                setTimeout(function() {
                                    copyButton.textContent = '复制';
                                }, 2000);
                            })
                            .catch(function(err) {
                                console.error('Clipboard API 复制失败:', err);
                                // 如果 Clipboard API 失败，尝试使用传统方法
                                fallbackCopyToClipboard();
                            });
                    } else {
                        // 对于不支持 Clipboard API 的浏览器，使用传统方法
                        fallbackCopyToClipboard();
                    }
                    
                    // 传统复制方法作为后备
                    function fallbackCopyToClipboard() {
                        // 创建临时文本区域
                        var textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        textArea.style.top = '0';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            var successful = document.execCommand('copy');
                            if (successful) {
                                copyButton.textContent = '已复制!';
                                setTimeout(function() {
                                    copyButton.textContent = '复制';
                                }, 2000);
                            } else {
                                copyButton.textContent = '复制失败';
                            }
                        } catch (err) {
                            copyButton.textContent = '复制失败';
                            console.error('传统复制方法失败:', err);
                        }
                        
                        document.body.removeChild(textArea);
                    }
                });
                
                // 添加按钮到代码块
                pre.style.position = 'relative';
                pre.appendChild(copyButton);
            });
            
            // 确保Prism重新高亮所有代码块
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
    </script>
</body>
</html>
